<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gran Rifa Solidaria, Séptimos básicos viaje a Pellines 2026</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* A light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }
        .container {
            max-width: 700px; /* Slightly wider for new content */
            width: 100%;
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded borders */
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
        }
        .draw-button, .clear-button {
            background-image: linear-gradient(to right, #6EE7B7 0%, #34D399 51%, #10B981 100%);
            margin: 10px; /* Adjusted for two buttons */
            padding: 15px 45px;
            text-align: center;
            text-transform: uppercase;
            transition: 0.5s;
            background-size: 200% auto;
            color: white;
            box-shadow: 0 0 20px #eee;
            border-radius: 10px;
            display: inline-block; /* Changed to inline-block for side-by-side display */
            width: fit-content;
            cursor: pointer;
            border: none;
            font-weight: 700;
            letter-spacing: 1px;
        }
        .draw-button:hover:not(:disabled), .clear-button:hover:not(:disabled) {
            background-position: right center;
            color: #fff;
            text-decoration: none;
        }
        .draw-button:disabled, .clear-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .number-display {
            font-size: 3rem;
            font-weight: 700;
            color: #10B981;
            margin-top: 10px;
            padding: 15px;
            background-color: #ecfdf5;
            border-radius: 0.75rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }
        .info-text {
            color: #6B7280;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }
        .card-info-section {
            background-color: #f8fafc; /* A lighter gray for info sections */
            border-radius: 1rem;
            padding: 25px;
            margin-top: 25px;
            text-align: left;
            border: 1px solid #e2e8f0;
        }
        .card-info-section h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
            text-align: center;
        }
        .card-info-section p, .card-info-section ul, .card-info-section li {
            color: #4a5568;
            line-height: 1.6;
        }
        .card-info-section ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        .button-group {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .results-table-section {
            margin-top: 40px;
            background-color: #f8fafc;
            border-radius: 1rem;
            padding: 25px;
            border: 1px solid #e2e8f0;
        }
        .results-table-section h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .results-table th, .results-table td {
            border: 1px solid #e2e8f0;
            padding: 12px 15px;
            text-align: center;
            font-size: 0.9rem;
        }
        .results-table th {
            background-color: #e2e8f0;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
        }
        .results-table tbody tr:nth-child(odd) {
            background-color: #fcfdfe;
        }
        .results-table tbody tr:hover {
            background-color: #f0f4f8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6">Gran Rifa Solidaria, Séptimos básicos viaje a Pellines 2026</h1>

        <p class="info-text">
            Haz clic en el botón para generar aleatoriamente el cartón ganador y un número dentro de ese cartón.
            ¡Mucha suerte!
        </p>

        <!-- Sección de Motivo de la Rifa (Actualizada) -->
        <div class="card-info-section">
            <h3>Motivo de la Rifa</h3>
            <p>
                Esta es una <strong>GRAN RIFA SOLIDARIA</strong> con un valor de $1.000 por cartón, organizada
                en beneficio de los Séptimos Básicos 2025 del Colegio St. Thomas Morus,
                para juntar fondos para su viaje a Pellines en 2026.
            </p>
            <p class="mt-4">
                ¡Gracias por tu apoyo y por ser parte de este noble objetivo!
            </p>
        </div>

        <!-- Sección de Premios Sorteados (Actualizada) -->
        <div class="card-info-section">
            <h3>Premios Sorteados</h3>
            <ul class="mt-4">
                <li><strong>1ER PREMIO:</strong> $200.000</li>
                <li><strong>2DO PREMIO:</strong> $100.000</li>
                <li><strong>3ER Y 4TO PREMIO:</strong> $50.000 C/U</li>
            </ul>
            <p class="mt-4">
                Los dineros serán transferidos a la cuenta que el ganador indique.
            </p>
        </div>

        <!-- Nueva Sección de Condiciones del Sorteo -->
        <div class="card-info-section">
            <h3>Condiciones del Sorteo</h3>
            <p>
                Para garantizar la transparencia y equidad del sorteo, se aplican las siguientes condiciones:
            </p>
            <ul class="mt-4">
                <li><strong>Cartones Válidos:</strong> Los cartones sorteados estarán en el rango de 1 a 225.</li>
                <li><strong>Cartones Excluidos:</strong> Los cartones <strong>127</strong> y <strong>128</strong> no fueron vendidos y, por lo tanto, no pueden ser ganadores. Si alguno de estos números es sorteado, el sistema automáticamente realizará un nuevo sorteo interno hasta obtener un cartón válido.</li>
                <li><strong>Sorteos "Al Agua":</strong> Antes de cada premio oficial, se realizarán aleatoriamente entre 1 y 3 sorteos "al agua". Estos sorteos intermedios no otorgan premio y están diseñados para añadir emoción al evento. La aplicación indicará si un sorteo se ha ido "al agua" y cuántos intentos adicionales quedan para el premio actual.</li>
                <li><strong>Determinación del Ganador:</strong> Una vez que los sorteos "al agua" asignados para un premio se han completado, el siguiente sorteo realizado será el ganador oficial de ese premio.</li>
            </ul>
            <p class="mt-4">
                ¡La honestidad y la emoción son nuestra prioridad!
            </p>
        </div>

        <!-- Controles y resultados del sorteo -->
        <div class="button-group">
            <button id="drawButton" class="draw-button">
                Realizar Sorteo
            </button>
            <button id="clearButton" class="clear-button">
                Limpiar Resultados
            </button>
        </div>

        <!-- Sección de resultados del sorteo -->
        <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="section-title">Cartón Sorteado</h2>
            <div id="winningCarton" class="number-display">--</div>
            <p class="text-gray-500 mt-2">El número de cartón sorteado (entre 1 y 225, excluyendo 127 y 128).</p>
        </div>

        <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="section-title">Número Sorteado dentro del Cartón</h2>
            <div id="winningNumberInCarton" class="number-display">--</div>
            <p class="text-gray-500 mt-2">El número específico dentro del cartón sorteado (del 1 al 10).</p>
        </div>

        <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="section-title">Boleto Resultado</h2>
            <div id="globalWinningTicket" class="number-display">--</div>
            <p class="text-gray-500 mt-2" id="globalTicketInfo">Este es el identificador único del boleto resultante.</p>
        </div>

        <!-- Mensaje de confirmación -->
        <div id="messageBox" class="hidden mt-6 bg-blue-100 border border-blue-400 text-blue-700 px-4 py-3 rounded relative" role="alert">
            <strong class="font-bold">¡Sorteo realizado!</strong>
            <span class="block sm:inline" id="messageText"></span>
            <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('messageBox').classList.add('hidden');">
                <svg class="fill-current h-6 w-6 text-blue-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Cerrar</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0
 0 1 0 1.698z"/></svg>
            </span>
        </div>

        <!-- Sección de Tabla de Ganadores -->
        <div id="resultsTableSection" class="results-table-section">
            <h3>Historial de Ganadores</h3>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Premio</th>
                        <th>Cartón Ganador</th>
                        <th>Número Interno</th>
                    </tr>
                </thead>
                <tbody id="resultsTableBody">
                    <!-- Los resultados se insertarán aquí por JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- Sección de Tabla de "Al Agua" -->
        <div id="alAguaTableSection" class="results-table-section">
            <h3>Historial de Sorteos "Al Agua"</h3>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>Premio Intento</th>
                        <th>Cartón</th>
                        <th>Número Interno</th>
                    </tr>
                </thead>
                <tbody id="alAguaTableBody">
                    <!-- Los resultados "al agua" se insertarán aquí por JavaScript -->
                </tbody>
            </table>
        </div>

    </div>

    <script>
        // Get references to HTML elements
        const drawButton = document.getElementById('drawButton');
        const clearButton = document.getElementById('clearButton');
        const winningCartonDisplay = document.getElementById('winningCarton');
        const winningNumberInCartonDisplay = document.getElementById('winningNumberInCarton');
        const globalWinningTicketDisplay = document.getElementById('globalWinningTicket');
        const globalTicketInfo = document.getElementById('globalTicketInfo');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');
        const resultsTableBody = document.getElementById('resultsTableBody'); // Table for winners
        const alAguaTableBody = document.getElementById('alAguaTableBody'); // Table for "al agua" draws

        // Initial state of the global ticket info paragraph
        const initialGlobalTicketInfoText = "Este es el identificador único del boleto resultante.";

        // Define excluded carton numbers
        const excludedCartons = [127, 128];

        // Definition of prizes in reverse draw order
        const prizes = [
            { name: '4to Premio x $50.000' },
            { name: '3er Premio x $50.000' },
            { name: '2do Premio x $100.000' },
            { name: '1er Premio x $200.000' }
        ];

        let currentDrawIndex = 0; // Index to track which prize is being drawn
        let recordedResults = []; // Array to store winning draw results
        let recordedAlAguaResults = []; // Array to store "al agua" draw results
        let alAguaDrawsRemaining = 0; // Counter for "al agua" draws remaining for the current prize

        /**
         * Generates a random integer between a minimum and maximum (inclusive).
         * @param {number} min - The minimum allowed value.
         * @param {number} max - The maximum allowed value.
         * @returns {number} A random integer.
         */
        function getRandomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * Generates a random carton number, excluding specific numbers.
         * @param {number} min - The minimum allowed carton number.
         * @param {number} max - The maximum allowed carton number.
         * @param {Array<number>} excluded - An array of carton numbers to exclude.
         * @returns {number} A valid random carton number.
         */
        function getValidRandomCarton(min, max, excluded) {
            let carton;
            do {
                carton = getRandomInt(min, max);
            } while (excluded.includes(carton));
            return carton;
        }

        /**
         * Animates the display of numbers for a given element, then displays the final value.
         * @param {HTMLElement} displayElement - The HTML element to update with animated numbers.
         * @param {number} min - Minimum random number for animation.
         * @param {number} max - Maximum random number for animation.
         * @param {number} durationMs - Duration of the animation in milliseconds.
         * @param {*} finalValue - The actual winning value to display at the end. Can be a string or number.
         * @param {Function} callback - Function to call after the animation completes.
         * @returns {void}
         */
        function animateDraw(displayElement, min, max, durationMs, finalValue, callback) {
            let startTime = Date.now();
            let intervalId = setInterval(() => {
                if (Date.now() - startTime < durationMs) {
                    // For carton animation, ensure it doesn't show excluded numbers during animation
                    let animatedValue = getRandomInt(min, max);
                    if (displayElement.id === 'winningCarton') {
                        while (excludedCartons.includes(animatedValue)) {
                            animatedValue = getRandomInt(min, max);
                        }
                    }
                    displayElement.textContent = animatedValue;
                } else {
                    clearInterval(intervalId);
                    displayElement.textContent = finalValue;
                    if (callback) {
                        callback();
                    }
                }
            }, 100);
        }

        /**
         * Renders the stored winning results in the HTML table.
         * @returns {void}
         */
        function renderResultsTable() {
            resultsTableBody.innerHTML = ''; // Clear the table before rendering
            recordedResults.forEach(result => {
                const row = resultsTableBody.insertRow();
                row.insertCell().textContent = result.prize;
                row.insertCell().textContent = result.carton;
                row.insertCell().textContent = result.internalNumber;
            });
        }

        /**
         * Renders the stored "al agua" results in their HTML table.
         * @returns {void}
         */
        function renderAlAguaResultsTable() {
            alAguaTableBody.innerHTML = ''; // Clear the table before rendering
            recordedAlAguaResults.forEach(result => {
                const row = alAguaTableBody.insertRow();
                row.insertCell().textContent = result.prizeAttempt;
                row.insertCell().textContent = result.carton;
                row.insertCell().textContent = result.internalNumber;
            });
        }

        /**
         * Resets all the displayed results, the history tables, and draw state.
         */
        function clearResults() {
            winningCartonDisplay.textContent = '--';
            winningNumberInCartonDisplay.textContent = '--';
            globalWinningTicketDisplay.textContent = '--';
            globalTicketInfo.textContent = initialGlobalTicketInfoText;
            messageBox.classList.add('hidden');

            currentDrawIndex = 0; // Reset draw counter
            recordedResults = []; // Clear winning results array
            recordedAlAguaResults = []; // Clear "al agua" results array
            renderResultsTable(); // Update winners table (will be empty)
            renderAlAguaResultsTable(); // Update "al agua" table (will be empty)

            // Initialize "al agua" draws remaining for the first prize (random between 1 and 3)
            alAguaDrawsRemaining = getRandomInt(1, 3);

            drawButton.disabled = false; // Enable draw button
            drawButton.textContent = `Realizar Sorteo para el ${prizes[0].name}`; // Update button text for the first prize
        }

        /**
         * Performs the carton and internal number draw with animation.
         * Disables the button during the draw.
         * @returns {void}
         */
        function performDraw() {
            if (currentDrawIndex >= prizes.length) {
                // All prizes have been drawn
                messageText.textContent = ` ¡Todos los premios han sido sorteados! Presiona "Limpiar Resultados" para comenzar de nuevo.`;
                messageBox.classList.remove('hidden');
                drawButton.disabled = true;
                clearButton.disabled = false;
                return;
            }

            // Disable buttons during the draw
            drawButton.disabled = true;
            clearButton.disabled = true;

            // Reset current displays
            winningCartonDisplay.textContent = '--';
            winningNumberInCartonDisplay.textContent = '--';
            globalWinningTicketDisplay.textContent = '--';
            globalTicketInfo.textContent = initialGlobalTicketInfoText;
            messageBox.classList.add('hidden');

            const currentPrize = prizes[currentDrawIndex];
            // Get a valid random carton, excluding 127 and 128
            const finalWinningCarton = getValidRandomCarton(1, 225, excludedCartons);

            // 1. Start animation for "Cartón Sorteado"
            // The animation will show random numbers within the range,
            // but the final value will be a valid carton number.
            animateDraw(winningCartonDisplay, 1, 225, 10000, finalWinningCarton, () => {
                // Callback once carton animation ends
                const finalWinningNumberInCarton = getRandomInt(1, 10);

                // 2. Start animation for "Número Sorteado dentro del Cartón"
                animateDraw(winningNumberInCartonDisplay, 1, 10, 10000, finalWinningNumberInCarton, () => {
                    // Callback once internal number animation ends

                    // Display the result ticket in "Cartón X - Número Y" format
                    globalWinningTicketDisplay.textContent = `${finalWinningCarton} - ${finalWinningNumberInCarton}`;

                    // Update the informational text below the result ticket
                    globalTicketInfo.textContent = `Este boleto corresponde al Cartón ${finalWinningCarton} - Número ${finalWinningNumberInCarton}.`;

                    // "Al Agua" logic
                    if (alAguaDrawsRemaining > 0) {
                        alAguaDrawsRemaining--; // Decrement "al agua" counter
                        
                        // Record "al agua" draw
                        const alAguaAttemptNumber = (getRandomInt(1, 3) - alAguaDrawsRemaining);
                        recordedAlAguaResults.push({
                            prizeAttempt: `${currentPrize.name} (Intento ${alAguaAttemptNumber})`,
                            carton: finalWinningCarton,
                            internalNumber: finalWinningNumberInCarton,
                        });
                        renderAlAguaResultsTable(); // Update "al agua" table

                        messageText.textContent = ` Lamentablemente te fuiste Al Agua, mejor suerte para la próxima. Queda${alAguaDrawsRemaining === 1 ? ' ' : 'n '}${alAguaDrawsRemaining} sorteo${alAguaDrawsRemaining === 1 ? '' : 's'} "al agua" para el ${currentPrize.name}.`;
                        if (alAguaDrawsRemaining === 0) {
                             messageText.textContent = ` ¡Este es el último intento antes del ${currentPrize.name} oficial!`;
                        }
                        messageBox.classList.remove('hidden');
                        
                        // Enable button to draw again for the SAME prize
                        drawButton.disabled = false;
                        clearButton.disabled = false;

                    } else {
                        // This is the WINNING draw for the current prize

                        // Record the WINNING draw result
                        recordedResults.push({
                            prize: currentPrize.name,
                            carton: finalWinningCarton,
                            internalNumber: finalWinningNumberInCarton,
                        });
                        renderResultsTable(); // Update winners table with the new result

                        // Display winner confirmation message
                        messageText.textContent = ` ¡${currentPrize.name} ha sido sorteado! El cartón ganador es el ${finalWinningCarton}, con el número interno ${finalWinningNumberInCarton}.`;
                        messageBox.classList.remove('hidden');

                        currentDrawIndex++; // Move to the next prize
                        if (currentDrawIndex < prizes.length) {
                            // If there are more prizes, initialize "al agua" counter for the next prize (random between 1 and 3)
                            alAguaDrawsRemaining = getRandomInt(1, 3);
                            drawButton.textContent = `Realizar Sorteo para el ${prizes[currentDrawIndex].name}`;
                            drawButton.disabled = false; // Enable for the next draw
                        } else {
                            // All prizes have been drawn
                            drawButton.textContent = 'Todos los Sorteos Completados';
                            drawButton.disabled = true;
                        }
                        clearButton.disabled = false; // Enable clear button
                    }
                });
            });
        }

        // Assign events to buttons
        drawButton.addEventListener('click', performDraw);
        clearButton.addEventListener('click', clearResults);

        // Initial setup when page loads
        window.onload = () => {
            clearResults(); // Ensures tables and displays are clear and button text is correct
        };
    </script>
</body>
</html>
